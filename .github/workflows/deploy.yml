name: Deploy Next.js to Azure VM

on:
  push:
    branches:
      - main # Adjust if using a different branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set Up Node.js & Install Dependencies
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "npm"

      - name: ğŸ—ï¸ Build Next.js Application
        run: |
          echo "Installing production dependencies..."
          npm ci --omit=dev

          echo "Starting Next.js build..."
          npx rimraf .next  # Ensures a clean build directory
          npm run build

          echo "âœ… Build completed successfully!"

      - name: ğŸ“‚ Debug - Verify Build Output
        run: |
          echo "Checking Next.js build output..."
          ls -la .next || echo "Error: .next directory not found"
          ls -la .next/standalone || echo "Error: .next/standalone directory not found"
          ls -la .next/static || echo "Error: .next/static directory not found"

      - name: ğŸš€ Deploy Build Files to VM via Rsync (Reliable Transfer)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Stop on error
            echo "Preparing deployment directory..."
            mkdir -p ~/deployments/clm_next/build

      - name: ğŸ“¤ Sync Build Files to VM
        run: |
          rsync -avz --progress \
            package.json package-lock.json \
            .next/standalone/server.js .next/standalone/package.json \
            .next/static public \
            ${{ secrets.SSH_USER }}@${{ secrets.AZURE_VM_IP }}:/home/gnelson/deployments/clm_next/build/

      - name: ğŸ”„ Restart Next.js Container
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Restarting Next.js service..."
            cd ~/deployments
            docker compose up -d --build clm_next
