name: Deploy Next.js to VM

on:
  push:
    branches:
      - main # Change if your branch name is different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Checkout Code
        uses: actions/checkout@v3

      - name: ⚙️ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 🛠 Install dependencies
        run: npm ci

      - name: 🧹 Install rimraf globally (if missing)
        run: npm install -g rimraf

      - name: ⚡ Build Next.js App
        run: |
          npm run clean || echo "Clean step skipped"
          npm run build
          echo "✅ Build completed successfully!"

      - name: 🔍 Debug - Check Next.js Build Output
        run: |
          echo "Checking Next.js build output..."
          ls -la .next || echo "Error: .next directory not found"
          ls -la .next/standalone || echo "Error: .next/standalone directory not found"

      - name: 🛠 Ensure standalone folder exists
        run: mkdir -p .next/standalone

      - name: 📂 Archive Build Files Before Transfer
        run: |
          tar -czf next-build.tar.gz package.json package-lock.json .next/standalone/ .next/static/ public/

      - name: 📂 Deploy Build Files to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: next-build.tar.gz
          target: "/home/gnelson/deployments/clm_next"
          timeout: 300s

      - name: 🔄 Restart Next.js Service
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/deployments  # ✅ Correct directory where docker-compose.yml is present
            echo "Removing old Next.js container..."
            docker stop clm_next || true
            docker rm clm_next || true
            echo "Extracting Next.js build files..."
            tar -xzf clm_next/next-build.tar.gz -C clm_next
            echo "Restarting Next.js container..."
            docker compose up -d --build --no-deps clm_next
            echo "Deployment complete!"
