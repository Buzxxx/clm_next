name: Deploy Next.js to VM

on:
  push:
    branches:
      - main # Change if your branch name is different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Checkout Code
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ›  Install dependencies
        run: npm ci --omit=dev # Install only production dependencies

      - name: ðŸ›  Ensure rimraf is available
        run: npm install rimraf --save-dev # Ensure rimraf is installed locally

      - name: âš¡ Build Next.js App
        run: |
          echo "ðŸš€ Cleaning old builds..."
          npx rimraf .next || echo "Clean step skipped"

          echo "ðŸš€ Starting Next.js build..."
          npm run build || (echo "âŒ Build failed!" && exit 1)

      - name: ðŸ” Debug - Verify Build Output
        run: |
          echo "ðŸ” Verifying Next.js build directories..."

          # Check if .next directory exists
          if [ -d ".next" ]; then
            echo "âœ… .next directory found"
            ls -la .next
          else
            echo "âŒ Error: .next directory not found" >&2
            exit 1
          fi

          # Check if .next/standalone directory exists
          if [ -d ".next/standalone" ]; then
            echo "âœ… .next/standalone directory found"
            ls -la .next/standalone
          else
            echo "âŒ Error: .next/standalone directory not found" >&2
            exit 1
          fi

          # Check if .next/static directory exists
          if [ -d ".next/static" ]; then
            echo "âœ… .next/static directory found"
            ls -la .next/static
          else
            echo "âŒ Error: .next/static directory not found" >&2
            exit 1
          fi

      - name: ðŸ“‚ Archive Build Files Before Transfer
        run: |
          echo "ðŸ“¦ Packaging standalone Next.js build..."

          # Ensure required directories and files exist before archiving
          if [ ! -d ".next/standalone" ]; then
            echo "âŒ Error: .next/standalone directory is missing, build might have failed!" >&2
            exit 1
          fi

          if [ ! -d "public" ]; then
            echo "âŒ Warning: public directory is missing, skipping it..."
            SKIP_PUBLIC=true
          fi

          if [ ! -f "package.json" ]; then
            echo "âŒ Error: package.json is missing, build cannot proceed!" >&2
            exit 1
          fi

          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Warning: Dockerfile is missing, skipping it..."
            SKIP_DOCKERFILE=true
          fi

          # Archive build files with correct structure
          tar -czf next-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              Dockerfile


          # Verify if archive was created successfully
          if [ -f "next-build.tar.gz" ]; then
            echo "âœ… Archive successfully created: next-build.tar.gz"
            ls -lh next-build.tar.gz
          else
            echo "âŒ Error: Archive creation failed!" >&2
            exit 1
          fi

      - name: ðŸ“‚ Deploy Build Files to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: next-build.tar.gz
          target: "/home/gnelson/deployments/clm_next"
          timeout: 300s

      - name: ðŸ”„ Restart Next.js Service
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit immediately if any command fails

            echo "ðŸ›  Checking if Docker is running..."
            systemctl is-active --quiet docker || (echo "âŒ Docker is not running!" && exit 1)

            echo "ðŸ›  Switching to deployment directory..."
            cd ~/deployments

            echo "ðŸ“¦ Extracting new standalone build..."
            tar -xzf clm_next/next-build.tar.gz -C clm_next --overwrite

            echo "ðŸš€ Restarting Next.js container with standalone build..."
            docker-compose up -d --build --force-recreate --no-deps clm_next || (echo "âŒ Docker Compose failed!" && exit 1)

            echo "âœ… Deployment complete!"

      - name: ðŸ” Validate Deployment
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ” Checking if Next.js is running..."
            if docker ps --filter "name=clm_next" --format '{{.Names}}' | grep -q clm_next; then
              echo "âœ… Next.js is running successfully!"
            else
              echo "âŒ Next.js failed to start!" >&2
              exit 1
            fi
